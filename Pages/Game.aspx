<%@ Page Title="Home Page" Language="C#" MasterPageFile="~/Pages/Site.Master" AutoEventWireup="true" CodeBehind="Game.aspx.cs" Inherits="BUNKER.Pages.Game" %>

<asp:Content ID="BodyContent" ContentPlaceHolderID="MainContent" runat="server">
    <div class="content-wrapper">
        <div class="player-slider">
        </div>
        
    </div>
    <!--Script references. -->
    <!--Reference the jQuery library. -->
    <script src="../Scripts/jquery-3.4.1.min.js"></script>
    <!--Reference the SignalR library. -->
    <script src="../Scripts/jquery.signalR-2.2.2.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="../wwwroot/js/signalr/dist/browser/signalr.js"></script>
    <script type="text/javascript" src='<%= ResolveClientUrl("~/signalr/hubs") %>'></script>    
    <script type="text/javascript" src="//cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.min.js"></script>

    <script src="../wwwroot/js/script.js"></script>
    <!--Add script to update the page and send messages.-->
   
    <script type="text/javascript"> 
        $(document).ready(function () {
            

            $('#displayname').val('*/<% = Session["Username"] %>/*');
            
            
        });
        $(function ()
        {

            var game = $.connection.userConnectionHub;
            $(".player-slider").slick({
                slidesToShow: 1,
                slidesToScroll: 1,
                prevArrow: "<button type='button' class='slick-prev pull-left'><i class='fa fa-angle-left' aria-hidden='true'></i></button>",
                nextArrow: "<button type='button' class='slick-next pull-right'><i class='fa fa-angle-right' aria-hidden='true'></i></button>"

            })
            
            game.client.AddCard = function (id, name)
            {
                if (!document.getElementById(id))
                { 
                    $(".player-slider").slick('slickAdd', '<div class="player-card-wrapper" id = ' + id +'>\
                        <div class="player-card-inner">\
                            <h3 class= "player-name" id = "player_name" >'+ name +' </h3> \
                            <a id = "job" >\
                            <div class="param-name">Професія</div>\
                            <div class="param-value"></div>\
                            </a>\
                            <a id ="bio" >\
                            <div class="param-name">Біо характеристики</div>\
                            <div class="param-value"></div>\
                            </a>\
                            <a id ="health" >\
                            <div class="param-name">Хвороба</div>\
                            <div class="param-value"></div>\
                            </a>\
                            <a id ="phobia" >\
                            <div class="param-name">Фобія</div>\
                            <div class="param-value"></div>\
                            </a>\
                            <a id ="hobby" >\
                            <div class="param-name">Хобі</div>\
                            <div class="param-value"></div>\
                            </a>\
                            <a id ="additional_info" >\
                            <div class="param-name">Доп. інформація</div>\
                            <div class="param-value"></div>\
                            </a>\
                            <a id ="knowledge" >\
                            <div class="param-name">Знання</div>\
                            <div class="param-value"></div>\
                            </a>\
                            <a id ="luggage" >\
                            <div class="param-name">Багаж</div>\
                            <div class="param-value"></div>\
                            </a>\
                        </div>\
                        <div class= "action-card use-card" >\
                            <div class="card-name">Картка дії</div>\
                            <div class="card-description"></div>\
                        </div>\
                        <div class="condition-card use-card">\
                            <div class="card-name">Картка умови</div>\
                            <div class="card-description"></div>\
                        </div >\
                   </div > ');
                }
                
            }
            game.client.loadInfo = function (card_id, div_id, characteristics)
            {
                var div = document.getElementById(card_id);
                var characteristics_link = div.querySelector('#' + div_id);
                
                characteristics_link.addEventListener('click', function handleClick(event) {
                    var button_card_id = event.target.parentElement.parentElement.parentElement.id;
                    var characteristics_to_share_id = event.target.parentElement.id;
                    loadCharacteristicsToAll(game, characteristics_to_share_id, button_card_id);
                });
                var val = characteristics_link.querySelector(".param-value");
                val.innerHTML = characteristics;
                
            }

            game.client.updateInfo = function (card_id, div_id, characteristics) {
                var div = document.getElementById(card_id);

                var characteristics_link = div.querySelector('#' + div_id);
                var val = characteristics_link.querySelector(".param-value");
                $(".player-slider").slick('slickGoTo', $("#"+card_id).attr("data-slick-index"), false);
                $(val).each(function(){
                    $(this).addClass("revealed");
                    $(this).text(characteristics);
                });

            }
            game.client.deleteCard = function (card_id) {
                $(".player-slider").slick('slickRemove', card_id - 1);

                //const element = document.getElementById(card_id);
                //element.remove();
            }

            

            $.connection.hub.start().done(function () {
                
                loadCards(game);
                connectUser(game);
                //loadCharacteristicsToCurrentUser(game);
                
            });


            function connectUser(userConnectionHub) {
                var UserName = '<% = Session["Username"] %>';
                userConnectionHub.server.connect(UserName);
            }
            function loadCards(userConnectionHub) {
                
                userConnectionHub.server.loadAllCards();
                
            }
            // fix 
            function loadCharacteristicsToCurrentUser(userConnectionHub) {
                <%--console.log('<% = Session["Username"] %>');--%>
                var UserName = '<% = Session["Username"] %>';
                userConnectionHub.server.loadOwnCharacteristics(UserName);

            }


            function loadCharacteristicsToAll(userConnectionHub, div_id,  id ) {
                var div = document.getElementById(id);
                var characteristics_link = div.querySelector('#'+div_id); 
                var val = characteristics_link.querySelector(".param-value").innerHTML;
                var UserName = '<% = Session["Username"] %>';
                userConnectionHub.server.shareCharacteristics(UserName, div_id, val);

            }
            
            
        });
        
    </script>

</asp:Content>

